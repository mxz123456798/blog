---
layout:     post
title:      "Java虚拟机中的内存区域"
subtitle:   ""
date:       2018-09-04 16:03:00
author:     "Max"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
    - java虚拟机
---

# Java虚拟机中的内存区域

![java虚拟机内存区域示意图](http://maxandroid.oss-cn-beijing.aliyuncs.com/18-9-4/38761418.jpg)

## 程序计数器

- 是一块较小的内存空间。用来记录当前线程所执行到的字节码的行号。因此每个线程都有一个独立的程序计数器。

- 如果当前执行的是java代码，程序计数器记录的就是正在执行的虚拟机字节码指令的地址。如果正在执行的是native方法，则程序计数器记录的值为空（Undefined）。

- 程序计数器是唯一一个在java虚拟机规范中没有规定oom的区域。

## java虚拟机栈

虚拟机栈与程序计数器一样，也是线程私有的。生命周期与线程相同。

### 栈桢

栈桢是每个java方法运行时会创建的一块内存区域，用于存储**局部变量表**、操作数栈、动态链接、方法出口等信息。一个方法从调用到执行结束对应一个栈桢在虚拟机栈中的入栈和出栈。

### 局部变量表

- 我们通常意义上所说的“栈”，指的就是**局部变量表**，它用于存储编译期可知的各种基本类型（boolean、byte、char、short、int、float、long、double）、对象引用和returnAddress类型（值指向一条虚拟机指令的操作码）。
- 局部变量表所需要的内存在**编译期间**完成分配，在进入一个方法时，这个方法所需分配的内存是**完全确定**且在方法运行期间**不会改变**的。

在这块内存区域中，如果线程申请的栈深度大于虚拟机所允许的栈深度，就会抛出StackOverflowError、而如果虚拟机可以动态扩展（大部分虚拟机都可以）但动态扩展时无法申请到足够的内存，就会抛出OutOfMemoryError。

## 本地方法栈

与java虚拟机栈基本一致，只不过java虚拟机栈执行的是java方法而本地方法栈执行的是native方法。

*有的虚拟机直接就把java虚拟机栈和本地方法栈合二为一*

## java堆

- 对于大多数应用来说，java堆是java虚拟机所管理的内存中的最大的一块。

- java堆是所有线程共享的区域，在虚拟机**启动时创建**
- 对象实例和数组都在堆上存储（栈上分配、标量替换优化技术会导致该条并不是那么绝对）

根据java虚拟机规范，java堆只要逻辑上连续即可（物理上可以不连续）。

当前主流的虚拟机的堆都是可扩展的（也可以固定大小），当堆中没有足够的空间来分配实例且无法扩展时，会抛出OutOfMemoryError。

## 方法区

方法区同样是各个线程共享的内存区域。它用于存储已经被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。

方法区与堆一样，逻辑上连续即可，同样也可以选择固定大小或可扩展。除此之外方法区还可以选择不实现垃圾回收，因为方法区上的垃圾回收回报比较低（垃圾回收会消耗资源但方法区中的值很少被回收）

当方法区无法满足内存分配需求时，会抛出OutOfMemoryError。

## 运行时常量池

运行时常量池是方法区的一部分。用于存放编译期生成的各种字面量和符号引用，这部分内容存在在Class文件中，在类加载后存放到方法区的运行时常量池中。

除此之外，翻译出来的直接引用也会被存储在运行时常量池中。

当常量池无法申请到内存时会抛出OutOfMemoryError。

## 直接内存

即运行虚拟机的计算机上的内存